---
title: 选redis还是memcache-转载
date: 2018-11-23 10:14:50
tags: Redis
cover_img: http://qiniucdn.timilong.com/15429394458.jpg
feature_img:
description: 选redis还是memcache, 看看面试官怎么说? 
keywords: Redis
categories: Redis
---

> 转载自: 微信公众号，[架构师之路](https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961269&idx=1&sn=ea447397423a2ad9d9f44ad51f0bed5e&chksm=bd2d02698a5a8b7f966f77c0283124e7d7dee42cc604b418b57ba4ff15e583fe2873a356dc31&scene=21#wechat_redirect)

# 选redis还是memcache, 面试官会问什么?
我在面试中，会如何向候选人提问？
一般，我不会预设任何问题，更不会问我擅长的领域。
我会先看简历上写了什么，比如“在项目中使用redis作为缓存存储”，我可能就会问，使用redis存储了什么，key是什么，value是什么，为什么选择redis而不是其他缓存。
所以，是不是问redis并不是重点，重点是简历写了什么。如果在简历上写，“在项目中使用hash作为内存存储结构”，我可能就会问，

## 使用hash存储了什么，key是什么，values是什么，为什么选择hash而不是其他数据结构。
不少听到我这么问的候选人，先是一愣，然后思索，不同的候选人给出的答案完全不一样。
有一些候选人，会说：
```
“架构师设计的，我只是使用”

或者

“公司要求统一使用redis作为缓存存储”

又或者

“我比较熟悉redis”
```

这类回答，是比较减分的，作为技术人，自己千万不能把自己当做“码农”，而要把自己当做“设计师”，日常工作中不能只是为了“完成交代下来的任务”。
还有一些候选人，他会进一步解释，例如：
```
“因为redis支持集群高可用，redis集群支持固化，所以选择了redis”
```
这类回答，说明候选人对redis进行过专门的学习，应该会非常好学。但是，ta们未必经得起后续的系列问题：

## “既然缓存的是用户信息，需要高可用么？”

回复：貌似不需要。

## “既然缓存的是订单信息，需要固化么？”

回复：貌似不需要。

## “那为什么还要选型redis呢？

回复：额...

能看到，这里，redis的一些特性，不能充分的作为，选型redis的理由。

## 任何脱离业务的架构设计，方案设计，技术选型都是耍流氓。
这不是一句空话。
做技术方案，技术选型的时候，一定是针对业务需求来折衷的。
> 假如存储的是用户信息，key是uid，value是User实体，当缓存挂了的时候，如果不会因为流量压到数据库而导致雪崩，此时缓存未必需要redis的集群功能。
> 假如存储的是订单信息，key是oid，value是Order实体，只作为缓存使用，允许cache miss读取数据库，此时未必需要redis的固化功能。

选择，因为在某个场景下，ta适合。
其实，我并没有对自己的提问，预设任何答案，只要候选人的思路是清晰的，逻辑是自洽的，即使给出的未必是最优的方案，也是能让人眼前一亮。
我们，因为项目的压力，历史的包袱，做出妥协性设计方案的次数还少么？技术人，清楚用什么，清楚怎么用还不够，更重要的是明白为什么。

## 技术人，需要一些情怀，多问自己一句为什么，对自己有好处。
你，真的理解面试官问题的用意了么？



# 选redis还是memcache，源码怎么说？
memcache和redis是互联网分层架构中，最常用的KV缓存。不少同学在选型的时候会纠结，到底是选择memcache还是redis。
画外音：不鼓励粗暴的实践，例如“memcache提供的功能是redis提供的功能的子集，不用想太多，选redis准没错”。

虽然redis比memcache更晚出来，且功能确实也更丰富，但对于一个技术人，了解“所以然”恐怕比“选择谁”更重要一些。

## 什么时候倾向于选择redis？
业务需求决定技术选型，当业务有这样一些特点的时候，选择redis会更加适合。

### 复杂数据结构
value是哈希，列表，集合，有序集合这类复杂的数据结构时，会选择redis，因为mc无法满足这些需求。
最典型的场景，用户订单列表，用户消息，帖子评论列表等。

### 持久化
mc无法满足持久化的需求，只得选择redis。
但是，这里要提醒的是，真的使用对了redis的持久化功能么？

千万不要把redis当作数据库用：
> （1）redis的定期快照不能保证数据不丢失
> （2）redis的AOF会降低效率，并且不能支持太大的数据量

不要期望redis做固化存储会比mysql做得好，不同的工具做各自擅长的事情，把redis当作数据库用，这样的设计八成是错误的。

### 缓存场景，开启固化功能，有什么利弊？
如果只是缓存场景，数据存放在数据库，缓存在redis，此时如果开启固化功能： 
> 优点是，redis挂了再重启，内存里能够快速恢复热数据，不会瞬时将压力压到数据库上，没有一个cache预热的过程。
> 缺点是，在redis挂了的过程中，如果数据库中有数据的修改，可能导致redis重启后，数据库与redis的数据不一致。

因此，只读场景，或者允许一些不一致的业务场景，可以尝试开启redis的固化功能。

### 天然高可用
redis天然支持集群功能，可以实现主动复制，读写分离。
redis官方也提供了sentinel集群管理工具，能够实现主从服务监控，故障自动转移，这一切，对于客户端都是透明的，无需程序改动，也无需人工介入。
而memcache，要想要实现高可用，需要进行二次开发，例如客户端的双读双写，或者服务端的集群同步。

但是，这里要提醒的是，大部分业务场景，缓存真的需要高可用么？
> （1）缓存场景，很多时候，是允许cache miss
> （2）缓存挂了，很多时候可以通过DB读取数据

所以，需要认真剖析业务场景，高可用，是否真的是对缓存的主要需求？
画外音：即时通讯业务中，用户的在线状态，就有高可用需求。

### 存储的内容比较大
memcache的value存储，最大为1M，如果存储的value很大，只能使用redis。

## 什么时候倾向于memcache？
纯KV，数据量非常大，并发量非常大的业务，使用memcache或许更适合。

这要从mc与redis的底层实现机制差异说起。

### 内存分配
memcache使用预分配内存池的方式管理内存，能够省去内存分配时间。
redis则是临时申请空间，可能导致碎片。
从这一点上，mc会更快一些。

### 虚拟内存使用
memcache把所有的数据存储在物理内存里。
redis有自己的VM机制，理论上能够存储比物理内存更多的数据，当数据超量时，会引发swap，把冷数据刷到磁盘上。
从这一点上，数据量大时，mc会更快一些。

### 网络模型
memcache使用非阻塞IO复用模型，redis也是使用非阻塞IO复用模型。
但由于redis还提供一些非KV存储之外的排序，聚合功能，在执行这些功能时，复杂的CPU计算，会阻塞整个IO调度。
从这一点上，由于redis提供的功能较多，mc会更快一些。

### 线程模型
memcache使用多线程，主线程监听，worker子线程接受请求，执行读写，这个过程中，可能存在锁冲突。
redis使用单线程，虽无锁冲突，但难以利用多核的特性提升整体吞吐量。
从这一点上，mc会快一些。

## 最后说两点
### 代码可读性，代码质量
看过mc和redis的代码，从可读性上说，redis是我见过代码最清爽的软件，甚至没有之一，或许简单是redis设计的初衷，编译redis甚至不需要configure，不需要依赖第三方库，一个make就搞定了。
而memcache，可能是考虑了太多的扩展性，多系统的兼容性，代码不清爽，看起来费劲。

例如网络IO的部分，redis源码1-2个文件就搞定了，mc使用了libevent，一个fd传过来传过去，又pipe又线程传递的，特别容易把人绕晕。
画外音：理论上，mc只支持kv，而redis支持了这么多功能，mc性能应该高非常多非常多，但实际并非如此，真的可能和代码质量有关。

### 水平扩展的支持
不管是mc和redis，服务端集群没有天然支持水平扩展，需要在客户端进行分片，这其实对调用方并不友好。如果能服务端集群能够支持水平扩展，会更完美一些。

